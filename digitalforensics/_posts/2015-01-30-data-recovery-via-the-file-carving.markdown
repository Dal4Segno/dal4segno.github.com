---
layout: post 
title: "파일 카빙을 통한 데이터 복구"
date: 2015-01-30 22:25:42
tag: digitalforensics filecarving datarecovery
categories: digitalforensics
excerpt: 파일 시스템의 도움을 받을 수 없을 경우 파일 카빙을 통해 데이터를 복구할 수 있다
---

{% include _toc.html %}

##파일(File)##

파일은 각종 컴퓨터 프로그램 등에서 사용하기 위한 데이터로서, 저장장치에 기록되어 사용된다. 종이 문서로 이루어진 '파일'과 같은 비슷한 역할이다.

##파일 시스템(File System)##
파일이 저장장치에 기록되어 있어도, 저장장치의 어느 위치에 저장되어 있는지 모른다면 해당 파일을 사용할 수 없을 것이다. 이런 일을 막기 위하여 각 저장장치에는 저장장치 내의 모든 파일들을 관리하는 **파일 시스템**이라는 것이 있다.

파일 시스템은 각 파일들이 어디에 저장되어 있는지 기록하여, 운영체제나 여러 프로그램들이 저장장치에 기록되어 있는 파일들을 원활하게 사용할 수 있게 한다. 또한, 생성/수정/접근 시간 등의 다양한 정보를 기록한다. 이렇게 파일을 위한 정보들은 **메타 데이터(Meta Data)**라 한다.

##할당(Allocation)##
파일 시스템이 각 파일이 어디에 저장되어 있는지 기록한다고 했는데, 이는 정확하게 말하면 파일 시스템이 해당 파일에게 저장 장치의 일정 영역을 **할당**하는 것이다. 이렇게 파일에게 할당된 영역은, 다른 파일들이 사용할 수 없다.

##파일 삭제##
파일을 삭제한다고 하면 파일의 데이터를 모두 제거한다고 생각하지만, 대부분의 파일 시스템에서는 그렇지 않다. 보통 파일에 할당된 영역을 할당 해제하여 다른 파일들이 사용할 수 있는 상태로 만들고, 해당 파일의 메타 데이터를 사용하지 않는 것으로 파일을 삭제한다.

모든 데이터를 삭제하지 않는 이유는 컴퓨터 내의 여러 장치에서 저장장치가 가장 느리기 때문에, 저장장치의 사용을 최대한 줄여야 컴퓨터의 전반적인 처리 속도를 높일 수 있다.

##파일 복구(Recover)##
위에서 설명한 대로 파일이 삭제되어도 데이터와 메타 데이터는 남아있기 때문에, 데이터가 다른 파일로 덮여쓰여지지 않았다면, 메타 데이터에 기록되어 있는 할당 영역을 살펴보면 어렵지 않게 파일을 복구해낼 수 있다.

##파일 카빙(Carving)##
하지만 메타 데이터 또한 다른 메타 데이터에 의해 덮여씌어질 수 있고, 모종의 이유로 손상/변조될 수 있다. 이런 경우에는 메타 데이터의 도움을 받지 못하기 때문에 분석가가 직접 저장장치에서 원하는 파일을 찾아내야 한다.

##파일 구조##

###시그니처(Signiture)###
여러 프로그램 등에서, 파일을 쉽게 구분하기 위해서 대부분의 파일은 데이터의 여러 위치에 **시그니처**를 새겨 놓는다. 일반적으로 데이터의 가장 앞에 있는 시그니처를 **헤더(Header)**, 마지막에 있는 시그니처를 **푸터(Footer) 혹은 트레일러(Trailer) 시그니처**라 한다.

파일의 구분 뿐만 아니라, 파일의 처리를 위해서 데이터를 여러 영역으로 구분하여 기록하는 경우도 있는데, 이런 경우에는 영역마다 시그니처가 붙어있는 경우도 있다.

![JPEG File Header]({{site.url}}/image/jpeg_header.png "JPEG 파일의 시그니처")

##비할당 영역(Unallocated Area)##
특정 파일을 카빙해내기 위해서는 단순히 저장장치의 모든 영역에 대해서 해당 파일의 시그니처를 탐색해내면 된다. 그러면, 그 파일과 같은 형식의 파일을 전부 찾을 수 있고, 찾아낸 파일 중에서 원하는 파일을 찾으면 된다. 

하지만, 저장장치의 전 영역을 살펴보는 것은 용량에 따라 매우 긴 시간이 필요한 작업이 될 수도 있고, 저렇게 찾아낸 파일은 **복구가 필요하지 않은**, 지워지지 않은 파일일 수도 있다. 따라서, 검색 대상을 **지워진** 파일로 한정할 필요가 있다.

위에서, 파일이 파일 시스템으로 부터 공간을 할당받는다고 했는데, 이렇게 파일에게 할당되지 않은 공간을 **비할당 영역**이라 한다. 이 비할당 영역은 파일에 할당되지 않은 공간과, 파일이 삭제됨에 따라 할당이 해제된 영역을 포함한다. 파일 시스템은 저장장치의 할당 상태를 기록하고 있으므로, 파일 시스템이 손상되지 않았다면 쉽게 비할당 영역을 추려낼 수 있다.

따라서, 비할당 영역을 대상으로 시그니처 탐색을 수행하면 조금 더 빠르게 원하는 파일을 찾아낼 수 있다.

##조각화(Fragmentation)##
데이터가 덮어씌어져 복구가 불가능한 것 외에도, 파일 카빙 작업에 있어 큰 문제점이 있다. 파일이 생성되고 삭제되고 하는 과정을 반복하면 저장장치의 공간을 완벽하게 채워서 사용하지 못하고, 중간 중간에 크고 작은 빈 영역이 생기게 된다. 이러한 빈 영역들을 사용하다 보면, 파일의 데이터를 한 번에 다 기록하지 못하고 여러 영역에 나누어 기록하게 되는 경우가 있는데, 이를 **조각화(Fragmentation)**라 한다.

메타 데이터를 이용할 경우에는, 파일이 어느 영역을, 얼마나 할당 받았는지에 대한 기록이 있기 때문에 파일이 조각나도 문제없이 사용할 수 있지만, 메타 데이터의 도움을 받지 않는 파일 카빙 과정에서는 여러 문제점이 발생하는데, 특히

1. 파일 헤더부터 푸터까지 복구하는 경우, 중간에 다른 파일의 데이터가 포함되는지 알 수 없다.
2. 파일 헤더를 분석하여 파일 크기만큼 복구하는 경우, 파일의 일부분이 복구되지 않는다.

조각화를 극복하고 파일을 카빙해내려는 다양한 시도가 있으나, 아직은 완벽한 방법이 없는 것으로 보인다.

![Fragmented File]({{site.url}}/image/fragmentaion.png "조각난 파일")

##도구##
파일 카빙은 분석가가 직접 하나하나 하기엔 번거로운 작업이므로, 도와주는 도구가 여럿 있다.

[Forensic Wiki, Tools:Data_Recovery#Carving](http://www.forensicswiki.org/wiki/Tools:Data_Recovery#Carving)

##활용##
실수로 삭제한 파일을 복구 해낼 때도 사용할 수 있겠지만, 파일 카빙 기법은 침해 사고 대응 및 디지털 포렌식 분야에서 빛을 발한다.

현실의 범죄자들이 자신의 흔적을 지우려고, 남기지 않으려고 노력하듯이 해커, 악성코드, 바이러스등도 최대한 자신의 흔적을 남기지 않으려고 노력한다. 이 과정에서 자신들이 남긴 흔적(파일이나 각종 기록)들을 지우는 경우가 많은데, 이런 흔적들을 복구해내는 것이 큰 도움이 된다.

##참고 자료##
- [Wikipedia, English. Computer file](http://en.wikipedia.org/wiki/Computer_file)
- [Forensic Wiki. File Carving](http://www.forensicswiki.org/wiki/File_Carving#File_Carving_challenges_and_test_images)

##발표 자료##
[20150125 Security One 2nd, 파일 카빙을 통한 데이터 복구](https://onedrive.live.com/redir?resid=BF1489D51F814C5C!8265&authkey=!AP1vDhsDXxIg5HE&ithint=file%2cpptx)

발표 자료 대부분이 설명이 없는 그림입니다. 본 포스트와 함께 봐주세요. 
